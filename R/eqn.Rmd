---
title: "Methods and Results"
author: Kristoffer Wild
date: "`r Sys.Date()`"
output: 
  word_document:
    reference_docx: template.docx
editor_options: 
  chunk_output_type: console
---

``````{r setup, include=FALSE, eval = T, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
options(digits = 2)
rm(list=ls())
sessionInfo()
# Packages
pacman::p_load("tidyverse", "MASS", "brms", "bayestestR", "MCMCglmm", "quantreg","lmerTest", "emmeans", "latex2exp", "DHARMa", "tidybayes", "ggeffects", "bayesplot", "rstanarm", "plotrix", "emmeans", "patchwork", "ggExtra", "sjPlot", "lazerhawk", "kableExtra","flextable")
```
# Materials and methods
*Lizard collection and husbandry* 
<p>*Bassiana duperreyi –* The eastern three-lined skink, is an oviparous lizard that is a communal nester at cool high elevational populations (Shine et al. 2002). On 21 November 2020, a total of 25 nests and 40 eggs were opportunistically located by flipping rocks, logs, and other cover objects at two field locations within the Brindabella Range (Mount Ginini - 1640 m a.s.l., 35°31'29.6"S 148°46'58.7"E; Piccadilly Circus - 1240 m a.s.l., 35°21'42.0"S 148°48'12.5"E). These sites were selected because of prior work that documented high frequencies of sex reversal occurring within populations (Shine 2002; Dissanayake et al., 2021). At each nest, the number of eggs was documented and temperature dataloggers (iButton® model DS1921G, Maxim Integrated, San Jose, CA, USA; accuracy $\pm$ °C from -30°C to +70°C; diameter 17 mm, height 6.2 mm, mass 3.2 g) were placed at the core of each nest to monitor nest temperatures in order to determine developmental rates. Using mean nest temperatures at each location (Mount Ginini [20.42°C $\pm$  SD 0.84] & Piccadilly Circus [18.94°C $\pm$ SD 0.98]; Dissanayake et al., in 2021), we allowed each nest to be exposed in natural conditions for 9-10 weeks at which ensured approximately 90% of the development period (Shine et al. 2002). Eggs were then collected and placed in moist vermiculite (water potential – 200kPa). Eggs were transported back to University of Canberra where they were placed in incubators that maintained 23°C, which the null expectation is 50% males (Shine et al., 2002). While in incubators, eggs were gently rotated every couple of days, and hatchlings were removed as soon as they emerged from the egg. See Dissanayake et al., in review for detail on discerption of study sites and general egg collection. Once hatchlings emerged, phenotypic sex was determined by squeezing the tail base to manfully evert hemipenes (Harlow, 1996). Tail tips (4-5 mm) were removed with a sterile blade and tail tips were collected into labeled 1.5 ml tubes containing 90% ethanol and remaining blood from tail was collected on Whatman FTATM Elute Micro Card/CAT No. WB120410. Lizards were then housed individually in plastic containers (0.35x0.25x0.15m) for a minimum of 2 weeks until respirometry experiments.<p>
<p>*Pogona vitticeps –*  The University of Canberra (UC) maintains a breeding colony of adult *P. vitticeps* where breeding groups of adult lizards comprised of three sex reversed females (ZZf) to one male (ZZ), and three ZW females to one male. During the summer of 2020–2021, females were allowed to lay eggs naturally and then eggs were collected at lay or within two hours of lay. Eggs (n= 96) were then placed in temperature-controlled incubators ($\pm$ 1°C) on moist vermiculite (water potential – 150kPa). Eggs were randomly allocated from each clutch (n = 20) and incubated at either 28°C (n= 43) or 34°C (n = 53) to ensure a balance across of phenotypic-genotypic combination of offspring when hatched. Once hatchlings emerged, phenotypic sex and tissue samples were following the same protocols for *B. duperreyi*. Hatchlings were then housed, 5 individuals per cage, in plastic containers (0.8x0.5x0.35m) for a minimum of 2 weeks until they were used for respirometry experiments.<p>
*Genotyping*
<p>Genotypic sex for both *B. duperreyi* and *P. vitticeps*, was determined using a polymerase chain reaction (PCR)-based molecular sex test from extracted DNA collected from tail tips or Whatman FTATM Elute Micro Card. DNA was extracted from tissue samples following the manufacturer protocols. DNA purity was determined using a NanoDrop 1000 spectrophotometer (NanoDrop Technologies Inc., Wilmington, DE, USA) and quantified using the Qubit 2.0 Fluorometric Quantitation (Invitrogen, Life technologies, Sydney, N.S.W., Australia). For *B. duperreyi* we tested for sex reversal using PCR as described by Quinn et al. (2009), where the genotypic sex was identified based off Y-specific markers allowing identification of XX and XY samples.  No XY females were observed, another indication that recombination and/or mutation involving these loci is negligible and has not affected the accuracy of genotypic sex assignment. Genotypic sex (ZZ/ZW) for *P. vitticeps*, was determined using a PCR based molecular sex test that amplifies a W-chromosome-specific size polymorphism (Holleley et al., 2015) using sex linked markers identified by Quinn et al. (2007). Two bands amplify in ZW individuals (identifying the presence of the W chromosome), whereas a single control band amplifies in ZZ individuals. All PCR products were visualized on a 1.5% agarose gel using SYBR Safe (Life Technologies, Carlsbad, USA), and all molecular sex tests were conducted blind to the phenotypic sex of the individuals. For both *B. duperreyi* and *P. vitticeps*, animals showing genotype–phenotype discordance were classified as sex-reversed (Shine et al., 2002; Holleley et al., 2015).<p>
*Respirometry*
<p>Standard metabolic rate (SMR) was defined as the average O$_{2}$ produced by an individual produced during the duration of each sampling period. A flow-through respirometry system was used to measure SMR of O$_{2}$ production (V̇O$_{2}$, mL min−1) with a stable systems FMS (Sables System FMS (Las Vegas NV, USA). A gas analyser sub-sampler pump was used to pump outside air scrubbed of CO$_{2}$ (using soda lime, Chem-Supply, **LOCATION**) and water vapour (using Drierite, W. A. Hammond Drierite Co. Ltd, **LOCATION**) to a mass flow controller that regulated flow rate to a nominal value of 130 ml min−1 (*B. duperreyi*) or 250 ml min$^{-1}$ (*P. vitticeps*). After passing through the mass flow controller, air was pushed through an airtight cylindrical respirometry chamber, which dimensions were designed specifically for each species (*B. duperreyi*: 75x20mm; *P. vitticeps*:200x40mm). Once air was pushed through chambers, it was then pushed to a flow meter which insured flow rates were constant. Air was then rescrubbed of water vapor (using Drierite) before being passed through a H$_{2}$O analyser, CO$_{2}$, and O$_{2}$ gas analysers. The fractional concentration of O$_{2}$ in the ex-current air (FEO$_{2}$) was recorded at a frequency of 1 Hz. Following the manufacture protocols, both CO$_{2}$ and O$_{2}$ analysers were calibrated prior to experiments. <p>
<p>To ensure lizards are at a postabsorptive state, lizards were fasted for a minimum 24 hours prior to respirometry measurements. Body mass of each lizard was measured to 0.01g using a digital sale (Ohaus SP-202) before and after being placed in respirometry chambers. Two incubators (LabWit, ZXSDR1090) were used to precisely control outside air being pulled into the respirometry system and another to control the temperature where chambers were placed for measurements taken for experiments ($\pm$ 0.01°C). Once lizards were placed in chambers, they were then placed inside incubators in the dark for approximately 12-14h beginning around dusk. Incubator temperatures held a constant temperature which was within the mean field body temperatures for each species, 34°C for *B. duperreyi* (Du et al., 2010) and 33°C *P. vitticeps* (Wild et al., *in prep*). Over a 65 min period each individual was measured at least once continuously for 5 min, with a control/baseline air sample immediately taken. To ensure animals were acclimated within chambers, the first 2 h of data was discarded from analysis. Output peaks of O$_{2}$ were identified using the R package “metabR” (github.com/daniel1noble/metabR) to calculate percentage of O$_{2}$ above baseline sample. The rate of O$_{2}$ produced by an individual was calculated following (Lighton 2008): 
$$
V_{02}\ mL\ min^{-1}= \frac{\%O_{2} (V_{Chamber}- V_{lizard})}{\ t} 
$$
Where the rate of O$_{2}$ is the maximum percentage of O$_{2}$ in a sample above that baseline; V$_{Chamber}$ is the volume of the chamber (B. duperreyi: 23.56 mL; P. vitticeps:251.33 mL); V$_{lizard}$ was calculated as an average between the prior and post chamber mass of each individual, and t is the duration of time in minutes between samples. The mass of each lizard was used as a proxy for its volume (1g = 1 ml) because of their high correlation and increased accuracy and precision in mismeasurements (Friesen et al., 2017). <p>
*Growth and survival *
<p>To determine how growth rates vary among sex classes, we used SVL and mass to estimate growth rates for *B. duperreyi* and *P. vitticeps*. Growth rate was calculated by dividing the change in growth (SVL or mass) between the initial measurement and subsequent remeasurment by the total number of days elapsed. Remeasurments were taken between 3-6 months prior to initial measurements. For both species survival of hatchlings was determined by documenting the frequency of mortality between hatch date and 6 months post hatch date. <p> 
*Statistical analysis*
<p>All statistical analysis were conducted using the R environment, ver. 4.1.0 (www.r.-project.org). Bayesian linear mixed effect models from the package “brms” (Burkner, 2017) were used to analyze O2 data for each species. With our “brms” models, we used default priors and ran 4 MCMC chains of 5000 with a burn in of 1000 and a thinning interval of 5. All models were checked for proper mixing and convergence by visually inspecting trace plots. For each species we fit two models, the first that assumed homoscedasticity within the data and the second that accounted for heteroscedasticity within the data. The first model for estimating metabolism was fit using the following structure: 
$$
MR_{ijk} = \left ( \beta_{0} + id_{j} + d_{k}\right) + \left( \beta_{6} +  \beta_{id_{ij})} \cdot time_{z} \right) + \beta_{1} \cdot Sex_{Male} + \beta_{2} \cdot Sex_{SR} + \beta_{3}  \cdot log \ Mass_{sc} \cdot Sex_{Female} + \beta_{4} \cdot log \ Mass_{sc} \cdot Sex_{Male} + \beta_{5} \cdot log \ Mass_{sc} \cdot Sex_{SR} + e_{ijk}
$$
Where $MR_{ijk}$ is the metabolic rate ($log\ VO_2 \cdot mL^{-1} \cdot min^{-1}$) for measurement *i* (i = 1 to $N_{m}$, number of measurements) on individual *j* (j = 1 to $N_{id}$, number of individuals) and day *k* (k = 1 to $N_{d}$, number of days).  We estimated a linear slope ($\beta_{6}$) for measurement time ($time_{z}$, z-transformed); a linear slope for log transformed mass ($log \ Mass_{sc}$, centered on mean, sc) and contrasts for the different sex classes ($\beta_{1}-\beta_{2}$), where $Sex_{Female}$ and $Sex_{Male}$ are for true sex and $Sex_{SR}$ sex reversed animals, respectively. We also estimated different mass scaling relationships for the different sex classes (i.e., $\beta_{4} \cdot log \ Mass_{sc} \cdot Sex_{Female}$ and  $\beta_{5} \cdot log \ Mass_{sc} \cdot Sex_{Male}$, respectively). We included a random intercept ($id_{j}$) and slope for $time_{z}$ ($\beta_{id_{ij}}$) for individual *j* across measurement occasions. Deviations were sampled from a multivariate normal distribution (~$MVN \left( [0,0], ID \right)$, where **ID** is a (co)variance matrix with a random intercept and slope variance and their covariance. We also included a random day effect ($d_{k}$) (~ $N\left( 0, \sigma^2_{k}\right)$).We compared differences in growth rates across sex classes for each species we fit a model using the following structure: 
$$
GR = \beta_{0} + \beta_{1} \cdot Int \ GM \cdot Sex_{Female} + \beta_{2} \cdot Int \ GM \cdot Sex_{Male} \cdot Int \ GM \cdot Sex_{SR} + e_{i}
$$

Where growth rate ($GR$) SVL (mm/d) or mass (g/d) was estimated using final growth measurements and using initial growth measurements ($Int \ GM$) for SVL or mass as a covariate for each of the sex classes depending the growth rate. Fisher's exact tests were used to determine if there was an association between sex class and frequency of hatchling mortality after sex-months.<p>
<p>For all Bayesian models, we pooled posterior estimates from multiple chains and presented posterior means and their 95% crdible intervals. In order to test if sex-reversed individuals showed support for the like genotype (Genotype - Sex-reversed)  or like phenotype (Phenotype - Sex-reversed) hypothesis for each species, we calculated contrasts by subtracting the posterior distributions of each sex. To test if the magnitude of these differences varied significantly, we calculated probabilities of direction (*pd*) using the package ‘bayestestR’(Makowski et al. 2019a). The probability of direction (*pd*) is a index of effect existence that ranges from 50-100% and is calculated solely based off the posterior distributions. It describes the proportion of the posterior distribution that is within the posterior median. It describes the direction of the particular effect (positive or negative) in relation to the posterior median. A *pd* value of 95% can be interpreted as the effect is positive with a probability of 95%. This method is strongly correlated with the frequentist p-value (Makowski et al. 2019b), thus we report  the *pd* value and provided an estimated p-value using the 'pd_to_p' function within bayestestR (Makowski et al. 2019a).<p>
# Results
```{r Bassiana metabolism results, echo = FALSE, include = FALSE}
## pMCMC Function
# Calculates the, p-value or pMCMC value for a posterior distribution
# x The vector for the posterior distribution. Note that this will test the null hypothesis that the parameter of interest is significantly different from 0. 
pmcmc <- function(x){
  2*(1 - max(table(x<0) / nrow(x)))
}

# raw data
bassiana.data <- read.csv("~/Dropbox/energy_sex_reversal/final.analysis.data/Bassiana.finalO2.sexreversal.analysis.data.clean.csv") %>% 
  rename(day =date.dd.mm.yy.,
         time = marker_sample,
         id = bd_liz_id, 
         O2_min = Final_MR_O2_min,
         sex = Geno.pheno,
         mass_g = mass) %>% 
  mutate(ztime = scale(time),
         logMass = scale(log(mass_g), scale = FALSE),
         zstartmass = scale(log(start_mass_g), scale = FALSE),
         zendmass = scale(log(end_mass_g), scale = FALSE))%>% 
  dplyr::select(-X, -Date.Hatched, -MR_O2_min)

# Bassiana sample size 
bassiana.sample.size <- bassiana.data %>%
  group_by(id, sex) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  group_by(sex) %>% 
  summarise(n = n()) %>% 
  mutate(total.sample.size = sum(n),
         total.n.samples = 760)

###### Body mass comparison with BRMS model  ######  
bass.bodymass <- read_rds("~/Dropbox/energy_sex_reversal/models/Bas_bodymass")
summary(bass.bodymass)
post_Bas_mass_m <- posterior_samples(bass.bodymass, pars = "^b")
XXf.mass <- as.array(post_Bas_mass_m[,"b_Intercept"])
XXm.mass <- as.array(XXf.mass +  post_Bas_mass_m[,"b_sexXXm"]) # sex reversed
XYm.mass <- as.array(XXf.mass +  post_Bas_mass_m[,"b_sexXYm"])

# H1: Mass of sex reversed and concordant male
Bass.Pheno.mass <- XXm.mass - XYm.mass
pmcmc.Pheno.mass. <- pmcmc(Bass.Pheno.mass)
# H2: Mass of sex reversed and concordant female
Bass.Geno.mass <-  XXm.mass - XXf.mass 
pmcmc.geno.mass <- pmcmc(Bass.Geno.mass)
# H3: Mass of concordant sexes
Bass.Concordant.Sex <-  XXf.mass - XYm.mass 
pmcmc.geno.mass <- pmcmc(Bass.Concordant.Sex)


######  Metabolic rate results Bassiana ######  
# loo comparison
Bas_m1_brms <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Bas_m1_brms")
Bas_m2_brms <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Bas_m2_brms")
bass.loo <- as.data.frame(loo_compare(Bas_m1_brms, Bas_m2_brms))
bass.r2 <- bayes_R2(Bas_m1_brms)

# Metabolism model output table
Bas_m1_table <- lazerhawk::brms_SummaryTable(Bas_m1_brms, round = 2)
Bas_m1_table

# Overall SEX differences in MR
# 1) extract for posteriors values to test like phenotype and like genotype hypothesis
post_Bas_m1 <- posterior_samples(Bas_m1_brms, pars = "^b")
variable.names(post_Bas_m1)


######### Hypothesis testing -  ACCOUNTING FOR INTERACTION BETWEEN SEX AND MASS
## extracting posteriors for interaction of sex and mass
XXf.mass.posterior <- as.array( post_Bas_m1[,"b_logMass"])
XXm.mass.posterior <- as.array(XXf.mass.posterior +  post_Bas_m1[,"b_sexXXm:logMass"]) # sex reversed
XYm.mass.posterior <- as.array(XXf.mass.posterior +  post_Bas_m1[,"b_sexXYm:logMass"])

# H1: Like Phenotype Hypothesis
Bass.Pheno.mass.diff.m1 <- XYm.mass.posterior - XXm.mass.posterior
pmcmc.Pheno.mass.m1 <- pmcmc(Bass.Pheno.mass.diff.m1)
# H2: Like Genotype Hypothesis
Bass.Geno.mass.diff.m1 <-  XXf.mass.posterior - XXm.mass.posterior 
pmcmc.geno.mass.m1 <- pmcmc(Bass.Geno.mass.diff.m1)
```
*Energetic Costs of Sex-reversal*
<p>*Bassiana duperreyi –* We recorded a total of `r bassiana.data %>% nrow()` observations for `r bassiana.sample.size[1,3]` individuals (XXf: *n = `r bassiana.sample.size[1,2]`*, XXm: *n = `r bassiana.sample.size[2,2]`*, XYm: *n = `r bassiana.sample.size[3,2]`*). Pairwise comparisons of body mass across sex in *B. duperreyi* indicated no differences in body mass across our treatments (Figure 2A; Table S1). The homogeneous variance model was the most parsimonious ([heteroscedastic model – homoscedastic model] loo: `r bass.loo[2,1]`, SE = `r bass.loo[2,2]`), accounting for `r bass.r2[1,1]`% (95% CI:`r bass.r2[1,3]` - `r bass.r2[1,4]`) of the variation in metabolic rate. There was a strong scaling relationship between log metabolic rate and log mass (Table 1) that depended on sex class (significant interaction between sex*logmass - Figure 2A/2B). Interestingly, sex-reversed male B. duperreyi had a scaling relationship that was more similar their phenotypic counterparts (XYm - XXm; pd = 81%; p > 0.05; Table 2) than their genotypic counterparts (XXf - XXm; pd = 100%; p < 0.01). 
 <p>
```{r Pogona metabolism results, echo = FALSE, include = FALSE}
# raw data
pogona.data <- read.csv("~/Dropbox/energy_sex_reversal/final.analysis.data/Pogona.finalO2.sexreversal.analysis.data.clean.csv") %>% 
  rename(day =date.dd.mm.yy.,
         time = marker_sample,
         id = bd_liz_id, 
         O2_min = Final_MR_O2_min,
         sex = Geno.pheno,
         mass_g = mass) %>% 
  group_by(sex) %>% 
  mutate(ztime = scale(time),
         logmass = log(mass_g), 
         logMass = scale(log(mass_g), scale = FALSE),
         zstartmass = scale(log(start_mass_g), scale = FALSE),
         zendmass = scale(log(end_mass_g), scale = FALSE)) %>% 
  dplyr::select(-X, -Date.Hatched, -MR_O2_min)

# sample size 
pogona.sample.size <- pogona.data %>%
  group_by(id, sex) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  group_by(sex) %>% 
  summarise(n = n()) %>% 
  mutate(total.n.individuals = sum(n),
         total.n.samples = 1365)

###### Body mass comparison with BRMS model  ######  
pog.bodymass <- read_rds("~/Dropbox/energy_sex_reversal/models/Pog_bodymass")
summary(pog.bodymass)
post_Pog_mass_m <- posterior_samples(pog.bodymass, pars = "^b")
ZWf.mass <- as.array(post_Pog_mass_m[,"b_Intercept"])
ZZf.mass <- as.array(ZWf.mass +  post_Pog_mass_m[,"b_sexZZf"]) # sex reversed
ZZm.mass <- as.array(ZWf.mass +  post_Pog_mass_m[,"b_sexZZm"])

# H1: Mass of sex reversed and concordant females
Pog.Pheno.mass <- ZWf.mass - ZZf.mass
pmcmc.Pheno.mass. <- pmcmc(Pog.Pheno.mass)
# H2: Mass of sex reversed and concordant males
Pog.Geno.mass <-  ZZm.mass - ZZf.mass 
pmcmc.geno.mass <- pmcmc(Pog.Geno.mass)
# H3: Mass of concordant sexes
Pog.Concordant.mass <-  ZWf.mass - ZZm.mass 
pmcmc.geno.mass <- pmcmc(Pog.Concordant.mass)


######  Metabolic rate Pogona ######  
# loo comparison
Pog_m1_brms <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Pog_m1_brms")
Pog_m2_brms <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Pog_m2_brms")
pog.loo <- loo_compare(Pog_m1_brms, Pog_m2_brms)
pog.r2 <- bayes_R2(Pog_m2_brms)

# Metabolism model output table
Pog_m2_table <- lazerhawk::brms_SummaryTable(Pog_m2_brms, round = 2)
Pog_m2_table

# 1) extract for posteriors values to test like phenotype and like genotype hypothesis
post_Pog_m2 <- posterior_samples(Pog_m2_brms, pars = "^b")

######### Hypothesis testing -  ACCOUNTING FOR INTERACTION BETWEEN SEX AND MASS
## extracting posteriors for interaction of sex and mass
ZWf.mass.posterior <- as.array( post_Pog_m2[,"b_logMass"])
ZZf.mass.posterior <- as.array(ZWf.mass.posterior +  post_Pog_m2[,"b_sexZZf:logMass"]) # sex reversed
ZZm.mass.posterior <- as.array(ZWf.mass.posterior +  post_Pog_m2[,"b_sexZZm:logMass"])

# H1: Like Phenotype Hypothesis
Pog.Pheno.mass.diff.m2 <- ZWf.mass.posterior - ZZf.mass.posterior
pmcmc.Pheno.mass.m2 <- pmcmc(Pog.Pheno.mass.diff.m2)

# H2: Like Genotype Hypothesis
Pog.Geno.mass.diff.m2 <-  ZZm.mass.posterior - ZZf.mass.posterior 
pmcmc.geno.mass.m2 <- pmcmc(Pog.Geno.mass.diff.m2)
```
<p>*Pogona vitticeps -* We recorded a total of `r pogona.data %>% nrow()` observations for `r pogona.sample.size[1,3]` individuals (ZWf:*n = `r pogona.sample.size[1,2]`*, ZZf: *n = `r pogona.sample.size[2,2]`*, ZZm: *n = `r pogona.sample.size[3,2]`*). Pairwise comparisons of body mass across sex in *P. vitticeps* indicated no differences in body mass across our treatments (Figure 2C; Table S1). The heteroscedasticity variance model was the most parsimonious ([heteroscedastic model  – homoscedastic model] loo: ELPD = `r pog.loo[2,1]`, SE = `r pog.loo[2,2]`), accounting for `r pog.r2[1,1]`% (95% CI:`r pog.r2[1,3]` - `r pog.r2[1,4]`) of the variation in metabolic rate. There was a strong scaling relationshp between log metabolic rate and log mass (Table 1) that depended on sex class (significant interaction between sex logmass - Figure 2C/2D). Interestingly, sex-reversed female *P. vitticeps* had a scaling relationship that was more similar their phenotypic counterparts (ZZf-ZWf; *pd* = 97%; p = 0.05; Table 2) than their genotypic counterparts (ZWf -ZZf; *pd* = 100%; p < 0.01).
<p>
```{r bodymass survival, echo = FALSE, include = FALSE}
growth <- read.csv(file = "~/Dropbox/energy_sex_reversal/final.analysis.data/growth.bassiana.pogona.csv") %>% 
  dplyr::rename(sex = Geno.pheno)
########## Growth (MASS AND SVL)
# bassiana growth
bassiana.growth <- growth %>% 
  filter(Species == "Bassiana")
# 1) SVL
Bass.svl.mod <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Bass.svl.growth.mod")
# extract for posteriors values to test like phenotype and like genotype hypothesis
post_Bass_SVLgrowth <- posterior_samples(Bass.svl.mod, pars = "^b")
######## Hypothesis testing - Overall SEX SVL
## extracting posteriors for just sex
XXf.SVL.Growth.posterior <- as.array( post_Bass_SVLgrowth[,"b_SVL.1.mm"])
XXm.SVL.Growth.posterior <- as.array(XXf.SVL.Growth.posterior +  post_Bass_SVLgrowth[,"b_sexXXm:SVL.1.mm"]) # sex reversed
XYm.SVL.Growth.posterior <- as.array(XXf.SVL.Growth.posterior +  post_Bass_SVLgrowth[,"b_sexXYm:SVL.1.mm"])
# H1: Like Phenotype Hypothesis
Bass.Pheno.SVL.Growth.diff <- XXm.SVL.Growth.posterior - XYm.SVL.Growth.posterior
pmcmc.Pheno.SVL.Growth.diff <- pmcmc(Bass.Pheno.SVL.Growth.diff)
# H2: Like Genotype Hypothesis
Bass.Geno.mass.diff.m1 <-  XXf.SVL.Growth.posterior - XXm.SVL.Growth.posterior
pmcmc.geno.mass.m1 <- pmcmc(Bass.Geno.mass.diff.m1)

#2) MASS
Bass.Mass.mod <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Bass.Mass.growth.mod")
post_Bass_Massgrowth <- posterior_samples(Bass.Mass.mod, pars = "^b")
######## Hypothesis testing - Overall SEX Mass
## extracting posteriors for just sex
XXf.Mass.Growth.posterior <- as.array(post_Bass_Massgrowth[,"b_Mass.1.cg"])
XXm.Mass.Growth.posterior <- as.array(XXf.Mass.Growth.posterior +  post_Bass_Massgrowth[,"b_sexXXm:Mass.1.cg"]) # sex reversed
XYm.Mass.Growth.posterior <- as.array(XXf.Mass.Growth.posterior +  post_Bass_Massgrowth[,"b_sexXYm:Mass.1.cg"])
# H1: Like Phenotype Hypothesis
Bass.Pheno.Mass.Growth.diff <- XXm.Mass.Growth.posterior - XYm.Mass.Growth.posterior
pmcmc.Pheno.Mass.Growth.diff <- pmcmc(Bass.Pheno.Mass.Growth.diff)
# H2: Like Genotype Hypothesis
Bass.Geno.mass.diff.m1 <-  XXf.Mass.Growth.posterior - XXm.Mass.Growth.posterior 
pmcmc.geno.mass.m1 <- p_direction(Bass.Geno.mass.diff.m1)


# Pogona grwoth
Pogona.growth <- growth %>% 
  filter(Species == "Pogona")
# 1) SVL
Pog.svl.mod <- readRDS(file ="~/Dropbox/energy_sex_reversal/models/Pog.svl.growth.mod")
# extract for posteriors values to test like phenotype and like genotype hypothesis
post_Pog_SVLgrowth <- posterior_samples(Pog.svl.mod, pars = "^b")
######## Hypothesis testing - Overall SEX SVL
## extracting posteriors for just sex
ZWf.SVL.Growth.posterior <- as.array( post_Pog_SVLgrowth[,"b_SVL.1.mm"])
ZZf.SVL.Growth.posterior <- as.array(ZWf.SVL.Growth.posterior +  post_Pog_SVLgrowth[,"b_sexZZf:SVL.1.mm"]) # sex reversed
ZZm.SVL.Growth.posterior <- as.array(ZWf.SVL.Growth.posterior +  post_Pog_SVLgrowth[,"b_sexZZm:SVL.1.mm"])
# H1: Like Phenotype Hypothesis
Pog.Pheno.SVL.Growth.diff <- ZWf.SVL.Growth.posterior - ZZf.SVL.Growth.posterior
pmcmc.Pheno.SVL.Growth.diff <- pmcmc(Pog.Pheno.SVL.Growth.diff)
# H2: Like Genotype Hypothesis
Pog.Geno.mass.diff.m1 <-  ZZm.SVL.Growth.posterior - ZZf.SVL.Growth.posterior 
pmcmc.geno.mass.m1 <- p_direction(Pog.Geno.mass.diff.m1)

# 2) MASS
Pog.Mass.mod <- readRDS(file ="~/Dropbox/energy_sex_reversal/models/Pog.Mass.growth.mod")
# 2) extract for posteriors values to test like phenotype and like genotype hypothesis
post_Pog_Massgrowth <- posterior_samples(Pog.Mass.mod, pars = "^b")

######## Hypothesis testing - Overall SEX MASS
## extracting posteriors for just sex
ZWf.Mass.Growth.posterior <- as.array( post_Pog_Massgrowth[,"b_Mass.1.g"])
ZZf.Mass.Growth.posterior <- as.array(ZWf.Mass.Growth.posterior +  post_Pog_Massgrowth[,"b_sexZZf:Mass.1.g"]) # sex reversed
ZZm.Mass.Growth.posterior <- as.array(ZWf.Mass.Growth.posterior +  post_Pog_Massgrowth[,"b_sexZZm:Mass.1.g"])

# H1: Like Phenotype Hypothesis
Pog.Pheno.Mass.Growth.diff <- ZWf.Mass.Growth.posterior - ZZf.Mass.Growth.posterior
pmcmc.Pheno.Mass.Growth.diff <- pmcmc(Pog.Pheno.Mass.Growth.diff)
# H2: Like Genotype Hypothesis
Pog.Geno.mass.diff.m1 <-  ZZm.Mass.Growth.posterior - ZZf.Mass.Growth.posterior 
pmcmc.geno.mass.m1 <- pmcmc(Pog.Geno.mass.diff.m1)


############# SURVIVAL
# Bring in data,its with growth file
growth <- read.csv(file = "~/Dropbox/energy_sex_reversal/final.analysis.data/growth.bassiana.pogona.csv") %>% 
  dplyr::rename(sex = Geno.pheno)
bassiana.growth <- growth %>% 
  filter(Species == "Bassiana")
pogona.growth <- growth %>% 
  filter(Species == "Pogona")
#analysis - Bassiana
bassiana.table<- fisher.test(table(bassiana.growth$Dead.Y.N., bassiana.growth$sex)) # N.S.
Bassiana_chi_sq_final <- bassiana.growth %>% 
  group_by(Dead.Y.N., sex) %>%
  summarise(n = n()) 
# analysis - Pogona N.S.
pogona.table <- fisher.test(table(pogona.growth$Dead.Y.N., pogona.growth$sex)) # N.S.
# mortality chi_square Pogona
Pogona_chi_sq_final <- pogona.growth %>% 
  group_by(Dead.Y.N., sex) %>%
  summarise(n = n())
```
*Growth and Survival* 
<p>When testing if there were  differences in growth rates for *B. duperreyi* sex-reversed males (XXm) SVL-growth and mass growth did not support either hypothesis (Table 2; Table S2). Interestingly when testing for differences in growth rates in *P. vitticeps*, sex-reversed females (ZZf) had lower SVL-growth and mass growth than ZZm and ZWf (Table S2). We did not find support for either hypothesis when comparing SVL-growth (Table S2), but we did find that mass growth sex-reversed females was significantly lower than ZZm (Table 2). Over the six-month period, sex-reversed male *B. duperreyi* had the lowest rates of survival (77%; Table S4) in comparison to concordant females (87%) and concordant males (100%), but this relationship was non-significant (p > 0.05). Similarly in *P. vitticeps*  we found that sex-reversed individuals had the lowest rates of survival (75%; Table 3) in comparison to concordant females (83%) and concordant males (95%), but this relationship was non-significant (p > 0.05).<p>
\newpage
# Tables & Figures
Table 1. Model coefficients for each respective species, when testing whether sex affects the slope of metabolic rate. For both models, the intercept is concordant females. Metabolic rate was log transformed and mass and time were z-transformed. Columns l-95% CI and u-95% CI, are the the lower and upper bound of the 95% credible interval for each parameter, estimated from the posterior samples. 
```{r Table 1,echo= FALSE}
# bring in, combined and rename tables
Bas_m1_brms <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Bas_m1_brms")
Bas_m1_table <- lazerhawk::brms_SummaryTable(Bas_m1_brms)
Bas.postior.m1.table <- Bas_m1_table %>% 
  dplyr::mutate(Species = "B. duperreyi")
Pog_m2_brms <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Pog_m2_brms")
Pog_m2_table <- lazerhawk::brms_SummaryTable(Pog_m2_brms)
Pogona.m2.table  <- Pog_m2_table %>% 
  dplyr:: mutate(Species = "P. vitticeps")
Table1 <- rbind(Bas.postior.m1.table, Pogona.m2.table)
Table1  <-  Table1[,c(6,1,2,4,5)]
Table1[1,2] <- "Intercept (SexXXf)"
Table1[8,2] <- "Intercept (SexZWf)"

# Table1 Final table
Tbl.1 <-flextable(Table1) %>% 
  italic(i = 1:17, j = 1, italic = TRUE) %>% 
  hline(i=7, j = 1:5, part="body") %>% 
  padding(i= 7, padding = 15, padding.top = TRUE) %>% 
  merge_v(j = "Species") %>%  
  autofit(part = "all") %>% 
  align(align ="center", part = "all") %>% 
  font(part = "all", fontname = "Times New Roman") %>% 
  fix_border_issues() 
knitr::knit_print(Tbl.1)
```
\newpage
Table 2. Posterior distributions for metabolism (MR) and growth rate (SVL or mass) estimates when testing if sex-reversed individuals show support for like genotype or like phenotype hypothesis. Metabolism accounted for the effect of log body mass on metabolism. Estimates were comparisons from subtracting the posterior distribution of the median for sex-reversed individuals by either their phenotypic or genotypic counterparts, depending on the hypothesis being tested. Negative estimates indicate sex-reversed individuals had an overall lower posterior median than the hypothesis being tested, vice-versa. Pd values are probability of direction for each comparison and bold values indicate a significant difference for sex-reversed individuals when converting pd values to p values. 
```{r Table2 ,echo= FALSE, warning=FALSE}
######## MR
######### Hypothesis testing -  ACCOUNTING FOR INTERACTION BETWEEN SEX AND MASS
# 1) Bassiana 
# metabolism:extract for posteriors values to test like phenotype and like genotype hypothesis
Bas_m1_brms <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Bas_m1_brms")
post_Bas_m1 <- posterior_samples(Bas_m1_brms, pars = "^b")
XXf.MR.mass.posterior <- as.array( post_Bas_m1[,"b_logMass"])
XXm.MR.mass.posterior <- as.array(XXf.MR.mass.posterior +  post_Bas_m1[,"b_sexXXm:logMass"]) # sex reversed
XYm.MR.mass.posterior <- as.array(XXf.MR.mass.posterior +  post_Bas_m1[,"b_sexXYm:logMass"])
# H1: Like Phenotype Hypothesis
Bass.Pheno.MR <- XXm.MR.mass.posterior - XYm.MR.mass.posterior 
Bass.Pheno.MR.post <- describe_posterior(Bass.Pheno.MR, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
# "pmcmc value" 0.33
Bass.Pheno.MR.post.pmcmc <- pmcmc(Bass.Pheno.MR)
Bass.Pheno.MR.post$"pMCMC Value" = "pMCMC = 0.33"
Bass.Pheno.MR.post[1,1] = "XYm-XXm"
# H2: Like Genotype Hypothesis
Bass.Geno.MR <- XXm.MR.mass.posterior - XXf.MR.mass.posterior
Bass.Geno.MR.post <- describe_posterior(Bass.Geno.MR, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
# "pmcmc value" 0.33
Bass.Geno.MR.post.pmcmc <- pmcmc(Bass.Geno.MR)
Bass.Geno.MR.post$"pMCMC Value" = "pMCMC < 0.01"
Bass.Geno.MR.post[1,1] = "XXf-XXm"
# final MR df
Bass.MR.df <- rbind(Bass.Pheno.MR.post, Bass.Geno.MR.post) %>% mutate(Test = "Log MR ")

# - growth
# 1) SVL
Bass.svl.mod <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Bass.svl.growth.mod")
# extract for posteriors values to test like phenotype and like genotype hypothesis
post_Bass_SVLgrowth <- posterior_samples(Bass.svl.mod, pars = "^b")
## extracting posteriors for just sex
XXf.SVL.Growth.posterior <- as.array( post_Bass_SVLgrowth[,"b_SVL.1.mm"])
XXm.SVL.Growth.posterior <- as.array(XXf.SVL.Growth.posterior +  post_Bass_SVLgrowth[,"b_sexXXm:SVL.1.mm"]) # sex reversed
XYm.SVL.Growth.posterior <- as.array(XXf.SVL.Growth.posterior +  post_Bass_SVLgrowth[,"b_sexXYm:SVL.1.mm"])
# H1: Like Phenotype Hypothesis
Bass.Pheno.SVL <- XXm.SVL.Growth.posterior - XYm.SVL.Growth.posterior
Bass.Pheno.SVL.post <- describe_posterior(Bass.Pheno.SVL, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
# pmcmc value 0.29
Bass.Pheno.SVL.post.pmcmc <- pmcmc(Bass.Pheno.SVL)
Bass.Pheno.SVL.post$"pMCMC Value" = "pMCMC = 0.29"
Bass.Pheno.SVL.post[1,1] = "XYm-XXm"
# H2: Like Genotype Hypothesis
Bass.Geno.SVL <- XXm.SVL.Growth.posterior - XXf.SVL.Growth.posterior
Bass.Geno.SVL.post <- describe_posterior(Bass.Geno.SVL, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
# "pmcmc value <0.39
Bass.Geno.SVL.post.pmcmc  <- pmcmc(Bass.Geno.SVL)
Bass.Geno.SVL.post$"pMCMC Value" = "pMCMC = 0.39"
Bass.Geno.SVL.post[1,1] = "XXf-XXm"
# final SVL df
Bass.SVL.df <- rbind(Bass.Pheno.SVL.post, Bass.Geno.SVL.post) %>% mutate(Test = "SVL (mm/d)")

#2) MASS
Bass.Mass.mod <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Bass.Mass.growth.mod")
post_Bass_Massgrowth <- posterior_samples(Bass.Mass.mod, pars = "^b")
## extracting posteriors for just sex
XXf.Mass.Growth.posterior <- as.array(post_Bass_Massgrowth[,"b_Mass.1.cg"])
XXm.Mass.Growth.posterior <- as.array(XXf.Mass.Growth.posterior +  post_Bass_Massgrowth[,"b_sexXXm:Mass.1.cg"]) # sex reversed
XYm.Mass.Growth.posterior <- as.array(XXf.Mass.Growth.posterior +  post_Bass_Massgrowth[,"b_sexXYm:Mass.1.cg"])
# H1: Like Phenotype Hypothesis
Bass.Pheno.Mass <- XXm.Mass.Growth.posterior - XYm.Mass.Growth.posterior
Bass.Pheno.Mass.post <- describe_posterior(Bass.Pheno.Mass, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
# "pmcmc value" 0.73
Bass.Pheno.Mass.post.pmcmc <- pmcmc(Bass.Pheno.Mass)
Bass.Pheno.Mass.post$"pMCMC Value" = "pMCMC = 0.73"
Bass.Pheno.Mass.post[1,1] = "XYm-XXm"
# H2: Like Genotype Hypothesis
Bass.Geno.Mass <- XXm.Mass.Growth.posterior - XXf.Mass.Growth.posterior
Bass.Geno.Mass.post <- describe_posterior(Bass.Geno.Mass, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
# "pMCMC Value"" 0.24
Bass.Geno.Mass.post.pmcmc <- pmcmc(Bass.Geno.Mass)
Bass.Geno.Mass.post$"pMCMC Value" = "pMCMC = 0.24"
Bass.Geno.Mass.post[1,1] = "XXf-XXm"
# final MR df
Bass.Mass.df <- rbind(Bass.Pheno.Mass.post, Bass.Geno.Mass.post) %>% mutate(Test = "Mass (cg/d)")
# final
Bass.MR.Growth <- rbind(Bass.MR.df, Bass.SVL.df, Bass.Mass.df) %>% 
  mutate(Species = "B. duperreyi")

# 2) Pogona 
# - Metabolism :extract for posteriors values to test like phenotype and like genotype hypothesis
Pog_m2_brms <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Pog_m2_brms")
post_Pog_m2 <- posterior_samples(Pog_m2_brms, pars = "^b")
ZWf.MR.mass.posterior <- as.array( post_Pog_m2[,"b_logMass"])
ZZf.MR.mass.posterior <- as.array(ZWf.MR.mass.posterior +  post_Pog_m2[,"b_sexZZf:logMass"]) # sex reversed
ZZm.MR.mass.posterior <- as.array(ZWf.MR.mass.posterior +  post_Pog_m2[,"b_sexZZm:logMass"])
# H1: Like Phenotype Hypothesis
Pog.Pheno.MR <- ZZf.MR.mass.posterior - ZWf.MR.mass.posterior
Pog.Pheno.MR.post <- describe_posterior(Pog.Pheno.MR, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
Pog.Pheno.MR.post[1,1] = "ZWf-ZZf"
# "p value" 0.05
Pog.Pheno.MR.post.pmcmc <-pmcmc(Pog.Pheno.MR)
Pog.Pheno.MR.post$"pMCMC Value" = "pMCMC = 0.04"
# H2: Like Genotype Hypothesis
Pog.Geno.MR <- ZZf.MR.mass.posterior - ZZm.MR.mass.posterior
Pog.Geno.MR.post <- describe_posterior(Pog.Geno.MR, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
Pog.Geno.MR.post [1,1] = "ZZm-ZZf"
# "p value" <0.01
Pog.Geno.MR.post.pmcmc <-pmcmc(Pog.Geno.MR)
Pog.Geno.MR.post$"pMCMC Value" = "pMCMC < 0.01"
Pog.MR.df <- rbind(Pog.Pheno.MR.post, Pog.Geno.MR.post) %>% mutate(Test = "Log MR ")

# - Growth
# 1) SVL
Pog.svl.mod <- readRDS(file ="~/Dropbox/energy_sex_reversal/models/Pog.svl.growth.mod")
post_Pog_SVLgrowth <- posterior_samples(Pog.svl.mod, pars = "^b")
## extracting posteriors for just sex
ZWf.SVL.Growth.posterior <- as.array( post_Pog_SVLgrowth[,"b_SVL.1.mm"])
ZZf.SVL.Growth.posterior <- as.array(ZWf.SVL.Growth.posterior +  post_Pog_SVLgrowth[,"b_sexZZf:SVL.1.mm"]) # sex reversed
ZZm.SVL.Growth.posterior <- as.array(ZWf.SVL.Growth.posterior +  post_Pog_SVLgrowth[,"b_sexZZm:SVL.1.mm"])
# H1: Like Phenotype Hypothesis
Pog.Pheno.SVL <- ZZf.SVL.Growth.posterior - ZWf.SVL.Growth.posterior
Pog.Pheno.SVL.post <- describe_posterior(Pog.Pheno.SVL, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
# "pMCMC Value" 0.94
Pog.Pheno.SVL.post.pmcmc <- pmcmc(Pog.Pheno.SVL)
Pog.Pheno.SVL.post$"pMCMC Value" = "pMCMC = 0.94"
Pog.Pheno.SVL.post[1,1] = "ZWf-ZZf"
# H2: Like Genotype Hypothesis
Pog.Geno.SVL <- ZZf.SVL.Growth.posterior - ZZm.SVL.Growth.posterior
Pog.Geno.SVL.post <- describe_posterior(Pog.Geno.SVL, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
# "pMCMC Value = 0.48
Pog.Geno.SVL.post.pd <- pmcmc(Pog.Geno.SVL)
Pog.Geno.SVL.post$"pMCMC Value" = "pMCMC = 0.48"
Pog.Geno.SVL.post[1,1] = "ZZm-ZZf"
# final SVL df
Pog.SVL.df <- rbind(Pog.Pheno.SVL.post, Pog.Geno.SVL.post) %>% mutate(Test = "SVL (mm/d)")

# 2) MASS
Pog.Mass.mod <- readRDS(file ="~/Dropbox/energy_sex_reversal/models/Pog.Mass.growth.mod")
post_Pog_Massgrowth <- posterior_samples(Pog.Mass.mod, pars = "^b")
ZWf.Mass.Growth.posterior <- as.array( post_Pog_Massgrowth[,"b_Mass.1.g"])
ZZf.Mass.Growth.posterior <- as.array(ZWf.Mass.Growth.posterior +  post_Pog_Massgrowth[,"b_sexZZf:Mass.1.g"]) # sex reversed
ZZm.Mass.Growth.posterior <- as.array(ZWf.Mass.Growth.posterior +  post_Pog_Massgrowth[,"b_sexZZm:Mass.1.g"])
# H1: Like Phenotype Hypothesis
Pog.Pheno.Mass <- ZZf.Mass.Growth.posterior - ZWf.Mass.Growth.posterior 
Pog.Pheno.Mass.post <- describe_posterior(Pog.Pheno.Mass, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
# "pMCMC Value" 0.40
Pog.Pheno.Mass.post.pmcmc <- pmcmc(Pog.Pheno.Mass)
Pog.Pheno.Mass.post$"pMCMC Value" = "pMCMC = 0.40"
Pog.Pheno.Mass.post[1,1] = "ZWf-ZZf"
# H2: Like Genotype Hypothesis
Pog.Geno.Mass <- ZZf.Mass.Growth.posterior - ZZm.Mass.Growth.posterior
Pog.Geno.Mass.post <- describe_posterior(Pog.Geno.Mass, estimate = "median",
                                                   ci = .95, ci_method = "hdi")
# "p value" = 0.05
Pog.Geno.Mass.post.pmcmc <- pmcmc(Pog.Geno.Mass)
Pog.Geno.Mass.post$"pMCMC Value" = "pMCMC = 0.06"
Pog.Geno.Mass.post[1,1] = "ZZm-ZZf"
# final Mass df
Pog.Mass.df <- rbind(Pog.Pheno.Mass.post, Pog.Geno.Mass.post) %>% mutate(Test = "Mass (g/d)")
# Pogona all
Pog.MR.Growth <- rbind(Pog.MR.df, Pog.SVL.df, Pog.Mass.df) %>% 
  mutate(Species = "P. vitticeps")

# bring in final table
Table2 <- rbind(Bass.MR.Growth, Pog.MR.Growth) %>% 
  rename("Contrast" = "Parameter",
         "Estimate" = "Median",
         "l-95% CI" = "CI_low", 
         "u-95% CI" = "CI_high") %>% 
  as.data.frame() %>% 
  mutate_at(vars("Estimate","l-95% CI", "u-95% CI" ), funs(round(., 2))) 
Table2  <-  Table2[,c(13,12,1,2,4,5,11)]

Tbl2<-flextable(Table2) %>% 
  italic(i = 1:12, j = 1, italic = TRUE) %>% 
  hline(i=6, j = 1:7, part="body") %>% 
  padding(i= 3, padding = 15, padding.top = TRUE) %>% 
  merge_v(j = c("Species", "Test")) %>%  
  autofit(part = "all") %>% 
  align(align ="center", part = "all") %>% 
  font(part = "all", fontname = "Times New Roman") %>% 
  bold(i = c(2, 7, 8, 12), j = 3:7, bold = TRUE, part = "body") %>% 
  set_table_properties(layout = "autofit") %>% 
  fix_border_issues(part = "body")
knitr::knit_print(Tbl2)
```

\newpage
```{r Fig1,echo=FALSE, results='asis'}
knitr::include_graphics("./Figs/Theoretical framework.pdf")
```
Figure 1. Theoretical framework to test the metabolic consequences of sex-reversal using two model systems with different patterns of genetic sex determination Bassiana duperryii [XYm (concordant male): XXf (concordant female): XXm (sex-reversed male)] and Pogona vitticeps [ZW (concordant female): ZZ (concordant male): ZZf (sex-reversed female)]. Where these hypotheses are tested by comparing how the energetic requirements vary across body mass and sex for each system. In each graph the y axis is log-transformed metabolic rate and the x-axis is log-transformed body mass. The like phenotype hypothesis suggests that sex-reversed individuals will resemble their phenotypic counterparts regardless of their genotype. The like genotype hypothesis proposes that sex-reversed individuals will have similar energy requirements their genotypic counterparts regardless of their phenotype.

\newpage
```{r Fig2ABCD,echo= FALSE}
knitr::include_graphics("./Figs/Regression.Final.pdf")
```
Figure 2. Comparison of log metabolic rate (V$_{02}$ mL min$^{-1}$) across log body mass (g) by sex class for *Bassiana duperryii* (A-B) and *Pogona vitticeps* (C-D). Points represent  metabolic measurements for each individual in relation to mass of each individual(A-C). Fitted lines were obtained from predicted values from the brms model for each species and confidence bands were constructed from the SE of prediction values for each sex (A-C). Density plots above each regression plot denote the distribution in body mass (log mass) by sex for each species. To visualize how log metabolic rate changes across log body mass, panels (B-D) show the distribution of predicted metabolic at three areas of log body mass (mean, +1.5SD, and -1.5SD) denoted by the dash-dot line in panels A-C for each sex and species.

\newpage
Table S1. BRMS model coefficients for each respective species when testing mass differences across sex class for animals used in respirometry experiments. Mass was z-transformed and lower and upper bounds were derived from the 95% credible interval for each parameter, estimated from the posterior samples. Pd values are probability of direction for each comparison and p values were estimated from pd values. 
```{r TableS1,echo= FALSE}
# bring in, combined and rename tables
bass.bodymass <- read_rds("~/Dropbox/energy_sex_reversal/models/Bas_bodymass")
Bassiana.mass.table <- bass.bodymass %>%
  emmeans( ~ sex ) %>%
  gather_emmeans_draws() %>%
  median_qi() %>% 
  dplyr::rename(Estimate = .value,
         "u-95% CI" = .upper,
         "l-95% CI" = .lower) %>% 
  dplyr::select(-c(.width, .interval, .point)) %>% 
  dplyr::mutate(Species = "B. duperryii") %>% 
  as.data.frame()

###### Body mass comparison with BRMS model  ######  
bass.bodymass <- read_rds("~/Dropbox/energy_sex_reversal/models/Bas_bodymass")
summary(bass.bodymass)
post_Bas_mass_m <- posterior_samples(bass.bodymass, pars = "^b")
XXf.mass <- as.array(post_Bas_mass_m[,"b_Intercept"])
XXm.mass <- as.array(XXf.mass +  post_Bas_mass_m[,"b_sexXXm"]) # sex reversed
XYm.mass <- as.array(XXf.mass +  post_Bas_mass_m[,"b_sexXYm"])

# H1: Mass of sex reversed and concordant male; pMCMC  0.45
Bass.Pheno.mass <- XXm.mass - XYm.mass
Bass.pmcmc.Pheno.mass. <- pmcmc(Bass.Pheno.mass)
# H2: Mass of sex reversed and concordant female; pMCMC  0.17
Bass.Geno.mass <-  XXm.mass - XXf.mass 
Bass.pmcmc.geno.mass <- pmcmc(Bass.Geno.mass)
# H3: Mass of concordant sexes; pMCMC  0.61
Bass.Concordant.Sex <-  XXf.mass - XYm.mass 
Bass.pmcmc.concordant.mass <- pmcmc(Bass.Concordant.Sex)
# get bassiana sample size

Bass_sample_Size <- read.csv(file = "~/Dropbox/energy_sex_reversal/final.analysis.data/growth.bassiana.pogona.csv") %>% 
  dplyr::rename(sex = Geno.pheno) %>% 
  filter(Species == "Bassiana") %>% 
  group_by(sex) %>% 
  summarise("Sample Size" = n()) %>% 
  # pd estimates from pairwise comparisons XXm - XYm = 0.45; XXf - XXm = 0.17; XYm - XXf = 0.61
  mutate("Contrast" = c("XXf-XXm","XXm-XYm", "XYm-XXf"), 
         "pMCMC Value" = c("0.45", "0.91", "0.70"))
# bass final table
Bassiana.mass.table <- cbind(Bass_sample_Size, Bassiana.mass.table)


#####
# pogona
#####
pog.bodymass <- read_rds("~/Dropbox/energy_sex_reversal/models/Pog_bodymass")
Pogona.mass.table <- pog.bodymass %>%
  emmeans( ~ sex ) %>%
  gather_emmeans_draws() %>%
  median_qi() %>% 
  dplyr::rename(Estimate = .value,
         "u-95% CI" = .upper,
         "l-95% CI" = .lower) %>% 
  dplyr::select(-c(.width, .interval, .point)) %>% 
  dplyr::mutate(Species = "P. vitticeps") %>% 
  as.data.frame()
###### Body mass comparison with BRMS model  ######  
pog.bodymass <- read_rds("~/Dropbox/energy_sex_reversal/models/Pog_bodymass")
post_Pog_mass_m <- posterior_samples(pog.bodymass, pars = "^b")
ZWf.mass <- as.array(post_Pog_mass_m[,"b_Intercept"])
ZZf.mass <- as.array(ZWf.mass +  post_Pog_mass_m[,"b_sexZZf"]) # sex reversed
ZZm.mass <- as.array(ZWf.mass +  post_Pog_mass_m[,"b_sexZZm"])

# H1: Mass of sex reversed and concordant females; pMCMC  0.48
Pog.Pheno.mass <- ZWf.mass - ZZf.mass
pmcmc.Pheno.mass. <- pmcmc(Pog.Pheno.mass)
# H2: Mass of sex reversed and concordant males; pMCMC  0.44
Pog.Geno.mass <-  ZZm.mass - ZZf.mass 
pmcmc.geno.mass <- pmcmc(Pog.Geno.mass)
# H3: Mass of concordant sexes; pMCMC  0.96
Pog.Concordant.mass <-  ZWf.mass - ZZm.mass 
pmcmc.concordant.mass <- pmcmc(Pog.Concordant.mass)

# get sample size info
Pog_sample_Size <- read.csv(file = "~/Dropbox/energy_sex_reversal/final.analysis.data/growth.bassiana.pogona.csv") %>%
  dplyr::rename(sex = Geno.pheno) %>% 
  filter(Species == "Pogona") %>% 
  group_by(sex) %>% 
  summarise("Sample Size" = n()) %>% 
  # pd estimates from pairwise comparisons ZWf -ZZf = .76; ZZf - ZZm = 0.78; ZZm - ZWf = 0.5
  mutate("Contrast" = c("ZWf-ZZf","ZZf-ZZm", "ZZm-ZWf"), 
         "pMCMC Value" = c("0.48", "0.44", "0.96"))
#Pogona final table
Pogona.mass.table <- cbind(Pog_sample_Size, Pogona.mass.table) 

# final table
TableS1 <- rbind(Bassiana.mass.table, Pogona.mass.table) 
TableS1$Sex = TableS1$sex
TableS1  <-  TableS1[,c(9,1,2,6,7,8,3,4)]
TableS1 <- TableS1 %>% mutate_at(vars("Estimate","l-95% CI", "u-95% CI" ), funs(round(., 2))) 

# Tbl 1 final table 
Tbl.S1 <-flextable(TableS1) %>% 
  italic(i = 1:6, j = 1, italic = TRUE) %>%
  hline(i=3, j = 1:8, part="body") %>% 
  padding(i= 3, padding = 15, padding.top = TRUE) %>% 
  merge_v(j = "Species") %>%  
  autofit(part = "all") %>% 
  align(align ="center", part = "all") %>% 
  font(part = "all", fontname = "Times New Roman") %>% 
  fix_border_issues() %>% 
  set_table_properties(layout = "autofit") %>% 
  fontsize(i = NULL, j = NULL, size = 10, part = "body")
knitr::knit_print(Tbl.S1)
```
\newpage
Table S2. BRMS Model coefficients for SVL and mass growth rate estimates across sex class *Bassiana duperryii*. Growth rate was calculated by dividing the change in growth (SVL or mass) between the initial measurement and subsequent remeasurment by the total number of days elapsed. Due to the small size and rate of change in grams, mass was converted to centigrams (cg). Animals were remeasured between 3 and 6 months post hatch.
```{r TableS2, echo=FALSE}
###
# Bassiana Growth
# 1) SVL
Bass.svl.mod <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Bass.svl.growth.mod")
Bass.svl.tbl <- lazerhawk::brms_SummaryTable(Bass.svl.mod)
Bass.svl.tbl[1,1] <- "Intercept (sexXXf)"
Bass.svl.tbl[4,1] <- "SVL(mm)"
Bass.svl.tbl[5,1] <- "sexXXm:SVL(mm)"
Bass.svl.tbl[6,1] <- "sexXYm:SVL(mm)"
Bass.svl.tbl <- Bass.svl.tbl %>% mutate("Species" = "B. duperreyi", "Growth rate" = "SVL(mm/d)")

#2) MASS
Bass.Mass.mod <- readRDS(file = "~/Dropbox/energy_sex_reversal/models/Bass.Mass.growth.mod")
Bass.mass.tbl <- lazerhawk::brms_SummaryTable(Bass.Mass.mod)
Bass.mass.tbl[1,1] <- "Intercept (sexXXf)"
Bass.mass.tbl[4,1] <- "mass(cg)"
Bass.mass.tbl[5,1] <- "sexXXm:mass(cg)"
Bass.mass.tbl[6,1] <- "sexXYm:mass(cg)"
Bass.mass.tbl <- Bass.mass.tbl %>% mutate("Species" = "B. duperreyi", "Growth rate" = "mass(cg/d)")

### 
# final table
tables2 <- rbind(Bass.mass.tbl, Bass.svl.tbl) 
TableS2 <- tables2[,c(7,1,2,4,5)]
Tbl.S2 <- flextable(TableS2) %>% 
  italic(i = 1:12, j = 1, italic = TRUE) %>% 
  padding(i= 3, padding = 15, padding.top = TRUE) %>% 
  merge_v(j = c("Growth rate")) %>%  
  hline(i=c(6), j = 1:5, part="body") %>% 
  autofit(part = "all") %>% 
  align(align ="center", part = "all") %>% 
  font(part = "all", fontname = "Times New Roman") %>% 
  fix_border_issues() %>% 
  fontsize(i = NULL, j = NULL, size = 10, part = "body")
knitr::knit_print(Tbl.S2)

```
 
\newpage
Table S3. BRMS Model coefficients for SVL and mass growth rate estimates across sex class for *Pogona vitticeps*. Growth rate was calculated by dividing the change in growth (SVL or mass) between the initial measurement and subsequent remeasurment by the total number of days elapsed. Animals were remeasured between 3 and 6 months post hatch.
```{r TableS3, echo=FALSE}
###
# Pogona growth
# 1) SVL
Pog.svl.mod <- readRDS(file ="~/Dropbox/energy_sex_reversal/models/Pog.svl.growth.mod")
Pog.svl.tbl <- lazerhawk::brms_SummaryTable(Pog.svl.mod)
Pog.svl.tbl[1,1] <- "Intercept (sexZWf)"
Pog.svl.tbl[4,1] <- "SVL(mm)"
Pog.svl.tbl[5,1] <- "sexZZf:SVL(mm)"
Pog.svl.tbl[6,1] <- "sexZZm:SVL(mm)"
Pog.svl.tbl <- Pog.svl.tbl %>% mutate("Species" = "P. vitticeps", "Growth rate" = "SVL(mm/d)")

# 2) MASS
Pog.Mass.mod <- readRDS(file ="~/Dropbox/energy_sex_reversal/models/Pog.Mass.growth.mod")
Pog.mass.tbl <- lazerhawk::brms_SummaryTable(Pog.Mass.mod)
Pog.mass.tbl[1,1] <- "Intercept (sexZWf)"
Pog.mass.tbl[4,1] <- "mass(g)"
Pog.mass.tbl[5,1] <- "sexZZf:mass(g)"
Pog.mass.tbl[6,1] <- "sexZZm:mass(g)"
Pog.mass.tbl <- Pog.mass.tbl %>% mutate("Species" = "P. vitticeps", "Growth rate" = "mass(g/d)")


### 
# final table
tables3 <- rbind(Pog.svl.tbl, Pog.mass.tbl)
Tables3 <- tables3[,c(7,1,2,4,5)]
Tbl.s3 <- flextable(Tables3) %>% 
  italic(i = 1:12, j = 1, italic = TRUE) %>% 
  padding(i= 3, padding = 15, padding.top = TRUE) %>% 
  merge_v(j = c("Growth rate")) %>%  
  hline(i=c(6), j = 1:5, part="body") %>% 
  autofit(part = "all") %>% 
  align(align ="center", part = "all") %>% 
  font(part = "all", fontname = "Times New Roman") %>% 
  fix_border_issues() %>% 
  fontsize(i = NULL, j = NULL, size = 10, part = "body")
knitr::knit_print(Tbl.s3)

```
\newpage
Table S4. Frequency of mortality across sex class for *Bassiana duperryii* and *Pogona vitticeps*. These measurements were recorded from initial hatch date to 6 months post-hatch date. 
```{r Table S4,echo= FALSE}
growth <- read.csv(file = "~/Dropbox/energy_sex_reversal/final.analysis.data/growth.bassiana.pogona.csv") %>% 
  dplyr::rename(sex = Geno.pheno)
bassiana.growth <- growth %>% 
  filter(Species == "Bassiana")
pogona.growth <- growth %>% 
  filter(Species == "Pogona")
# bass.table
Bassiana.surv.table <- table(bassiana.growth$Dead.Y.N., bassiana.growth$sex) %>%  
  as.data.frame() %>% 
  mutate(Species = "B. duperryii") %>% 
  spread(Var1, Freq)
# pogona.table
pogona.surv.table <- table(pogona.growth$Dead.Y.N., pogona.growth$sex)%>%  
  as.data.frame() %>% 
  mutate(Species = "P. vitticeps") %>% 
  spread(Var1, Freq)
morality.frq <- rbind(Bassiana.surv.table, pogona.surv.table) %>% 
  dplyr::rename("Sex Class" = "Var2")
TableS4 <- morality.frq[,c(2,1,3,4)]

# final table
Tbl.S4 <-flextable(TableS4) %>% 
  italic(i = 1:6, j = 1, italic = TRUE) %>% 
  hline(i=3, j = 1:4, part="body") %>% 
  padding(i= 3, padding = 15, padding.top = TRUE) %>% 
  merge_v(j = "Species") %>%  
  autofit(part = "all") %>% 
  align(align ="center", part = "all") %>% 
  font(part = "all", fontname = "Times New Roman") %>% 
  fix_border_issues() 
knitr::knit_print(Tbl.S4)
```